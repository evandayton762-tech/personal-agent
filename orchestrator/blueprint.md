# Orchestrator Blueprint

This blueprint outlines how the orchestrator exposes endpoints, plans tasks, manages queues, and records cost information. It serves as a conceptual specification rather than executable code.

## A. Endpoints (conceptual)

The orchestrator exposes several conceptual endpoints:

- **/health**: Returns `ok` to signal that the orchestrator is alive.
- **/plan**: Accepts a `ProjectSpec` and returns a summary of the generated `Plan`.
- **/enqueue**: Accepts a full `Plan` or an individual `Step` and adds it to the execution queue.
- **/runs**: Lists recent runs, including their status and key metrics.
- **/parked**: Lists parked items awaiting user input or conditions to change.

## B. Planner Contract

The planner is invoked once per project. It receives the `ProjectSpec` and outputs a schema‑valid `Plan`. The planner must estimate token consumption for the plan and compare it to the `per_task_token_cap`. If the estimate exceeds the cap, the planner must downscope the plan to a minimum viable product (MVP) gate, clearly documenting what has been excluded or deferred.

## C. Queue Rules

The queue manages execution of steps and handles retries:

- **Retries**: Each step may be retried once if it fails, using an exponential backoff to avoid rapid repeated failures.
- **Timeouts**: A default timeout of 120 seconds applies to each step, with configurable overrides.
- **Concurrency**: The personal agent runs steps sequentially (concurrency of 1) to simplify state management. Future versions may allow parallelism.
- **On failure**: If a step fails after a retry, the orchestrator creates a `ParkedItem` with the failure reason and a proposed free alternative. Execution halts until user intervention.

## D. Cost Ledger

Every executed step records token and monetary usage in a cost ledger. Each entry includes:

- **task_id**: Identifier of the project.
- **step_id**: Identifier of the executed step.
- **tokens_in**: The number of tokens consumed as input to the language model.
- **tokens_out**: The number of tokens generated by the model.
- **usd**: Estimated dollar cost of the tokens and any third‑party services used.
- **timestamp**: When the step was executed.

The daily meter monitors cumulative costs. When usage reaches 90% of the daily cap, the orchestrator stops enqueuing new steps and defers remaining tasks to the next day.
